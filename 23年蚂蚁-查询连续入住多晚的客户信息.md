**题目来源：** https://www.nowcoder.com/practice/5b4018c47dfd401d87a5afb5ebf35dfd?tpId=375&tqId=10858425&sourceUrl=%2Fexam%2Foj%3FquestionJobId%3D2%26subTabName%3Donline_coding_page  
2025年12月6日

## 一、问题背景与目标
酒店管理系统中，需要根据入住与退房信息，计算用户在酒店的实际入住天数，并筛选出 **入住天数不少于 2 天** 的用户记录。  
同时，为了丰富结果，需要将房间类型（来自 guestroom_tb 表）一并查询并展示。

最终展示字段包括：
- 用户 ID（user_id）
- 房间 ID（room_id）
- 房间类型（room_type）
- 入住天数（days）

并按天数、房间 ID、用户 ID 降序排序输出。

---

## 二、最终 SQL

```sql
select
    c.user_id,
    c.room_id,
    g.room_type,
    datediff(c.checkout_time, c.checkin_time) as days
from checkin_tb c
left join guestroom_tb g on c.room_id = g.room_id
where datediff(c.checkout_time, c.checkin_time) >= 2
order by days, c.room_id, c.user_id desc;
```

## 三、解题思路
1. 明确入住天数计算方式  
MySQL 的 ** DATEDIFF(date1, date2)计算的是date1-date2的天数差 **  
因此入住天数应写为：  
DATEDIFF(c.checkout_time, c.checkin_time)  
筛选入住天数不少于 2 天的数据  
直接在 WHERE 子句中判断：  
DATEDIFF(c.checkout_time, c.checkin_time) >= 2  

2. 关联房间类型信息  
使用 LEFT JOIN 将入住记录表（checkin_tb）与客房表（guestroom_tb）基于 room_id 关联，获取 room_type。  
排序规则  
先按入住天数升序  
再按房间号升序  
最后按用户 ID 降序  
使用：  
order by days, c.room_id, c.user_id desc  

## 四、相关知识点
1. DATEDIFF() 函数
MySQL 中：
DATEDIFF(date1, date2) = date1 - date2（单位：天）
注意参数顺序非常重要。
2. LEFT JOIN 的作用
LEFT JOIN 会保留左表所有记录，即使右表没有匹配行。
用于确保所有入住记录都被输出。
3. WHERE 对计算字段的筛选
可以直接在 WHERE 中使用函数计算的结果来进行筛选。
4. ORDER BY 多字段排序
支持多个字段级联排序：
默认升序
对某字段指定 DESC 可改为降序
