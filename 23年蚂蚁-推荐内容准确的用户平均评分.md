题目来源：https://www.nowcoder.com/practice/2dcac73b647247f0aef0b261ed76b47e?tpId=375&sourceUrl=%2Fexam%2Foj%3FquestionJobId%3D2%26subTabName%3Donline_coding_page&difficulty=&judgeStatus=&tags=&title=&gioEnter=menu  
2025年12月9日

## 一、问题背景与目标
系统中包含两类数据：
- `recommend_tb`：记录系统给用户的推荐信息（如推荐对象、推荐标签等）
- `user_action_tb`：记录用户的行为及兴趣特征（如 hobby_l）与其评分（score）

目标是 **找出那些“推荐标签与用户兴趣标签一致”的用户**，然后从这些用户在 `user_action_tb` 中的记录中计算平均评分（保留 4 位小数）。

换句话说：
- 先找出被系统“精准推荐”的用户（rec_info_l = hobby_l）
- 再计算这些用户的平均 score

---

## 二、最终 SQL

```sql
select 
    round(avg(score),4) as avg_score
from user_action_tb
where user_id in (
    select distinct re.rec_user
    from recommend_tb re 
    join user_action_tb us on re.rec_user = us.user_id
    where re.rec_info_l = us.hobby_l
);
```

### 三、解题思路

1. **找到满足条件的用户集合**  
   - 从 `recommend_tb` 和 `user_action_tb` 进行关联。  
   - 条件是：`re.rec_user = us.user_id` 且 *推荐的兴趣类型* `rec_info_l` 与 *用户行为中的兴趣类型* `hobby_l` 完全一致。  
   - 使用 `select distinct re.rec_user` 获取唯一用户 ID。

2. **计算这些用户的平均分数**  
   - 外层查询从 `user_action_tb` 中筛选出 `user_id` 属于子查询返回的用户。  
   - 使用 `avg(score)` 统计平均分，并通过 `round(..., 4)` 保留 4 位小数。

3. **组合逻辑**  
   - 整体是典型的「从满足特定行为的用户集合中，再计算指标」的 SQL 套子查询模式。


### 四、相关知识点

1. **子查询（Subquery）**  
   - 用于先筛选出满足条件的用户集合，再在外层进行计算。  
   - 常用在 `IN`、`EXISTS` 中。

2. **聚合函数（Aggregate Functions）**  
   - `avg(score)`：对筛选出的用户行为评分求平均值。  
   - `round(value, n)`：数值保留指定的小数位。

3. **表连接（JOIN）**  
   - `recommend_tb` 与 `user_action_tb` 之间通过 `user_id` 字段进行连接。  
   - JOIN 使得推荐兴趣与用户真实兴趣进行匹配判断成为可能。

4. **distinct 去重**  
   - 推荐表可能存在重复记录，因此对用户进行去重以避免重复统计。

5. **条件过滤**  
   - 使用 `re.rec_info_l = us.hobby_l` 实现“推荐兴趣和用户兴趣一致”的业务逻辑。


